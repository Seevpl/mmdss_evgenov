# Лабораторная работа 5
Системно-динамическое моделирование.
## Цель работы
Научиться работать с моделями системно-динамического моделирования в приложении PowerSim, а также переводить их в код алгоритмического языка программирования.
## Задачи
1. Изучить модель-симулятор работы торговой точки, разработанную на занятии,
2. Дополнить модель, добавив в неё ещё один уровень, связанный с другими её элементами,
3. Вручную преобразовать модель в код алгоритмического языка программирования,
4. Изменить полученный код так, чтобы была возможность вводить в модель значения некоторых параметров на кажлом шаге её работы.
## Описание модели
### Общее описание
Модель включает в себя следующие уровни:
- BasicStore - значением уровня является количество единиц товара на базовом складе.
- Transport - значением уровня является количество единиц товара, находящегося в данный момент в перевозке с базового склада на склад магазина.
- ShopStore - значением уровня является количество единиц товара на складе магазина.
- AllLost значением уровня является количество единиц товара, которые были "потеряны". "Потерянными" считаются единицы товара, которые были привезены на склад магазина, но не смогли в него вместиться.
- Account - значением уровня являются деньги, имеющиеся в данный момент в распоряжении у магазина.

Первые 4 описанных уровня представляют из себя последовательную цепочку: BasicStore -> Transport -> ShopStore -> AllLost. В BasicStore товары попадают извне модели, посредством описанного потока закупок партий. В AllLost товары накапливаются, но никуда не уходят; этот уровень представляет из себя просто количество потерянных единиц товара, и не соотносится ни с каким местом хранения. Из ShopStore часть товара при неудачном планировании переходит в AllLost, но при грамотном управлении системой, весь товар попадёт за пределы программы через поток Selling.\
Уровень Account не связан через потоки с другими уровнями, так как в нём значением являются деньги, а не единицы товара. Деньги на этот уровень попадают извне системы через поток Income, а уходят через потоки VAT (налоги с продаж), DailySpending, TransSpend и OptPurchaseSpend.\
Модель имеет следующие потоки:
- SmallOptIncome - поступление товаров на базовый склад при покупке оптовой партии.
- TruckLoading - погрузка товара с базового склада в необходимое количество единиц транспорта.
- TruckUnloading - выгрузка товара из транспорта на склад магазина.
- Lost - потери товара при выгрузке из транспорта на склад магазина.
- Selling - уход единиц товара со склада магазина посредством их продажи.

Предыдущие потоки работали со значениями, отображающими количество единиц товара, следующие потоки отражают суммы денежных средств:
- Income - приход денег на счёт благодаря продаже товара.
- VAT - оплата налогов с продажи товара.
- DailySpending - обязательные ежедневные траты (налоги, аренда, электричество, зарплата сотрудникам и т.д.).
- TransSpend - траты на транспортировку товаров с базового склада на склад магазина.
- OptPurchaseSpend - траты на закупку новых партий товара.

Значения на потоках расчитываются с помощью множества вспомогательных переменных, констант и параметров, модифицируемых пользователем во время осуществления моделирования.
### Описание изменений в модели, произведённых в рамках выполнения данной работы
В рамках выполнения работы к исходной модели был добавлен выше уже упомянутый уровень Transport с двумя потоками (TruckLoading и TruckUnloading). Было решено, что для приближения модели к реальности, будет логично, если цена перевозки будет зависеть от объёма партии. Для этого была введена новая константа - TransportCapacity, отражающая вместимость используемых для перевозок транспортных средств. Вместимость была изначально установлена на 30 единиц. Константа TransferRate (стоимость перевозки) была переосмысленна, как стоимость перевозки груза одной машиной, и её значение было уменьшено до 75. Таким образом исходня цена перевозки (150) стала соответствовать перевозке двумя транспортными средствами (31-60 единиц товара).\
Также, были добавлены переменные, производящие расчёт количества транспортных средств, необходимого для перевозки выставленного пользователем количества единиц товара, и оценку того, на оплату скольких транспортных средств хватит денежных средств.\
Помимо вышеупомянутых изменений, в программу было добавлено недостающее списание со счёта денежных средств за осуществление закупки оптовой партии товара (поток OptPurchaseSpend).
## Алгоритм программы
### 1. Выбор индикатора
Было решено выбрать индикатор схождение/расхождение скользящих средних MACD. Данный индикатор рассматривался на лекции и был понятен в реализации.
### 2. Поиск данных
В качестве данных для работы был выбран массив данных Центробанка РФ о курсе швейцарского франка к рублю за период с 01.12.2022 по 01.12.2023. Массив был загружен и предобработан. В ходе предобработки были удалены лишние столбцы, а столбцы с релевантной информацией были преобразованы в удобный для дальнейшей работы формат.
### 3. Реализация индикатора и рекомендаций
Была рассмотрена схема вычисления индикатора, и данная схема была реализована на языке Python. Затем был создан класс MACD, который реализовывал индикатор на основе переданных данных и давал рекомендацию поведения для трейдера исходя из индикатора MACD.
## Пример работы приложения
Вот так выглядели исходные данные:\
![Screenshot of the initial data](/lab2/img4.png)\
Они были преобразованы к следующей форме:\
![Screenshot of the preprocessed data](/lab2/img5.png)\
Для построения индикатора необходимо было для начала реализовать вычисление экспоненциального скользящего среднего (EMA):\
![Screenshot of the ema code](/lab2/img0.png)\
Сам индикатор строится следующим образом:
1. Вычисляем EMA с периодом 12 дней на имеющихся данных (ema_12(data)),
2. Вычисляем EMA с периодом 26 дней на имеющихся данных (ema_26(data)),
3. Вычисляем MACD по формуле: macd = ema_12(data) - ema_26(data),
4. Вычисляем сигнальную линию, как скользящее среднее от MACD с периодом 9 дней.\

На скриншоте ниже показаны графики: 1 - реальных данных, ema_12 и ema_26; 2 - macd и сигнальной линии за одинаковый временной отрезок (по оси X указаны дни от начала временного отрезка).
![Screenshot of the plots](/lab2/img2.png)\
Рекомендации по индикатору MACD строятся следующим образом:
- После пересечения линией MACD сигнальной линией снизу вверх даётся рекомендация покупать.
- После пересечения линией MACD сигнальной линией сверху вверх даётся рекомендация продавать.
Реализация всего индикатора вместе с рекомендационной частью (но без функции, вычисляющей EMA) приведена на скриншоте ниже:
![Screenshot of the MACD class code](/lab2/img1.png)

Как можно было увидеть на ранее представленном графике, последнее произошедшее пересечение было пробитием линией MACD сигнальной линии снизу вверх, соответственно программа должна выдавать рекомендацию покупать.\
![Screenshot of the program work results](/lab2/img3.png)
## Заключение
Насколько можно увидеть, посмотрев на курс швейцарского франка к рублю, в целом, индикатор MACD выдал правильное предложение. Тем не менее, курс рос ещё очень недолгий период и ненамного. Однако, данный индикатор лёгок в использовании и прост в понимании, что повышает привлекательность его использования.