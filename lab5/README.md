# Лабораторная работа 5
Системно-динамическое моделирование.
## Цель работы
Научиться работать с моделями системно-динамического моделирования в приложении PowerSim, а также переводить их в код алгоритмического языка программирования.
## Задачи
1. Изучить модель-симулятор работы торговой точки, разработанную на занятии,
2. Дополнить модель, добавив в неё ещё один уровень, связанный с другими её элементами,
3. Вручную преобразовать модель в код алгоритмического языка программирования,
4. Изменить полученный код так, чтобы была возможность вводить в модель значения некоторых параметров на кажлом шаге её работы.
## Описание модели
### Общее описание
Модель включает в себя следующие уровни:
- BasicStore - значением уровня является количество единиц товара на базовом складе.
- Transport - значением уровня является количество единиц товара, находящегося в данный момент в перевозке с базового склада на склад магазина.
- ShopStore - значением уровня является количество единиц товара на складе магазина.
- AllLost значением уровня является количество единиц товара, которые были "потеряны". "Потерянными" считаются единицы товара, которые были привезены на склад магазина, но не смогли в него вместиться.
- Account - значением уровня являются деньги, имеющиеся в данный момент в распоряжении у магазина.

Первые 4 описанных уровня представляют из себя последовательную цепочку: BasicStore -> Transport -> ShopStore -> AllLost. В BasicStore товары попадают извне модели, посредством описанного потока закупок партий. В AllLost товары накапливаются, но никуда не уходят; этот уровень представляет из себя просто количество потерянных единиц товара, и не соотносится ни с каким местом хранения. Из ShopStore часть товара при неудачном планировании переходит в AllLost, но при грамотном управлении системой, весь товар попадёт за пределы программы через поток Selling.\
Уровень Account не связан через потоки с другими уровнями, так как в нём значением являются деньги, а не единицы товара. Деньги на этот уровень попадают извне системы через поток Income, а уходят через потоки VAT (налоги с продаж), DailySpending, TransSpend и OptPurchaseSpend.\
Модель имеет следующие потоки:
- SmallOptIncome - поступление товаров на базовый склад при покупке оптовой партии.
- TruckLoading - погрузка товара с базового склада в необходимое количество единиц транспорта.
- TruckUnloading - выгрузка товара из транспорта на склад магазина.
- Lost - потери товара при выгрузке из транспорта на склад магазина.
- Selling - уход единиц товара со склада магазина посредством их продажи.

Предыдущие потоки работали со значениями, отображающими количество единиц товара, следующие потоки отражают суммы денежных средств:
- Income - приход денег на счёт благодаря продаже товара.
- VAT - оплата налогов с продажи товара.
- DailySpending - обязательные ежедневные траты (налоги, аренда, электричество, зарплата сотрудникам и т.д.).
- TransSpend - траты на транспортировку товаров с базового склада на склад магазина.
- OptPurchaseSpend - траты на закупку новых партий товара.

Значения на потоках расчитываются с помощью множества вспомогательных переменных, констант и параметров, модифицируемых пользователем во время осуществления моделирования.
### Описание изменений в модели, произведённых в рамках выполнения данной работы
В рамках выполнения работы к исходной модели был добавлен выше уже упомянутый уровень Transport с двумя потоками (TruckLoading и TruckUnloading). Было решено, что для приближения модели к реальности, будет логично, если цена перевозки будет зависеть от объёма партии. Для этого была введена новая константа - TransportCapacity, отражающая вместимость используемых для перевозок транспортных средств. Вместимость была изначально установлена на 30 единиц. Константа TransferRate (стоимость перевозки) была переосмысленна, как стоимость перевозки груза одной машиной, и её значение было уменьшено до 75. Таким образом исходня цена перевозки (150) стала соответствовать перевозке двумя транспортными средствами (31-60 единиц товара). Помимо этого, был увеличен базовый объём оптовой партии, чтобы повысить необходимость использования более чем одного транспортного средства.\
Также, были добавлены переменные, производящие расчёт количества транспортных средств, необходимого для перевозки выставленного пользователем количества единиц товара, и оценку того, на оплату скольких транспортных средств хватит денежных средств.\
Помимо вышеупомянутых изменений, в программу было добавлено недостающее списание со счёта денежных средств за осуществление закупки оптовой партии товара (поток OptPurchaseSpend).
## Алгоритм программы
Здесь будет описан алгоритм программы на языке программирования Python, которая соответствует данной модели PowerSim.
### 1. Загрузка необходимых библиотек
![Screenshot of the code 0](/lab5/img0.png)\
В рамках составления программы были использованы библиотеки math и random. Первая библиотека использовалась для описания математических функций, необходимых для записи выражений некоторых переменных. Вторая библиотека применялась для получения случайных чисел, помогающих смоделировать флуктуации спроса на товар, его оптовой стоимости, размера оптовой партии.
### 2. Инициализация констант и параметров
![Screenshot of the code 1](/lab5/img1.png)\
Константы соответствуют тем, что использовались в PowerSim. Под параметрами подразумеваются значения, которые могут быть изменены пользователем, например opt_offer_accept_decision.\
Помимо констант и параметров здесь также инициализируются две переменные:\
cur_time - считает количество дней/шагов, прошедших с начала симуляции. По очевидным причинам при изменении своего значения данная переменная никак не соотносится с другими переменнами и константами. Тем не менее, некоторые переменные модели ссылаются на неё.\
sim_continue - пока её значение True, симуляция будет продолжаться. Вспомогательная переменная, не связанная напрямую с моделью.
### 3. Инициализация уровней
![Screenshot of the code 2](/lab5/img2.png)\
Уровни инициализируются согласно прописанным в PowerSim инициализационным значениям.
### 4. Инициализация переменных и потоков
![Screenshot of the code 3](/lab5/img3.png)\
Переменные и потоки инициализируются согласно формулам из PowerSim. Для определения последовательности вычисления переменных (и уровней) в Excel'е была создана специальная таблица зависимостей.\
![Screenshot of an Excel table](/lab5/img4.png)\
Зелёным отмечались выписываемые строки и рассматриваемые столбцы. Поскольку эта работа уже завершена, вся таблица полностью залита зелёным.
### 5. Вывод значений некоторых параметров в цикле
![Screenshot of the code 4](/lab5/img5.png)\
На скриншоте представлено начало основного цикла программы. В условии после while стоит значение True, так как выход из цикла осуществляется посредством оператора break. Так сделано по причине того, что выбор о продолжении или завершении симуляции пользователь делает перед тем, как ему будет предложено принять решения по работе магазина на данном шаге. Чтобы пользователю не приходилось вводить какие-то значения в дальнейшие вопросы, цикл просто прерывается.
### 6. Ввод пользователем новых значений определённых параметров
![Screenshot of the code 5](/lab5/img6.png)\
Первый вопрос, задаваемый пользователю, заключается в том, будет ли продолжена симуляция. При негативном на него ответе, как было упомянуто ранее, цикл прерывается.\
На этом скриншоте также показан пересчёт значений некоторых переменных и потоков, производимый сразу после ввода, связанных с ними параметров. Пришлось так реализовать для приближения к реализации в PowerSim. В PowerSim переменные и потоки связаны таким образом, что при изменении значения какого-то параметра тут же всё пересчитывается. В Python'e же приходится специально пересчитывать значения, что и было сделано. Если бы этот пересчёт происходил после пересчёта уровней, модель бы работала не совсем верно.
### 7. Пересчёт уровней, переменных и потоков
![Screenshot of the code 6](/lab5/img7.png)\
Здесь пересчитываются те значения переменных и потоков, которые не были напрямую связаны с пользовательским изменением параметров.
## Скриншоты модели в PowerSim
Скриншот схемы модели в PowerSim:\
![Screenshot of the model scheme](/lab5/img8.png)\
Скриншот изменённого экрана вывода значений некоторых переменных и уровней, а также изменения некоторых параметров:\
![Screenshot of the parameters panel](/lab5/img9.png)\
## Скриншоты программы на языке программирования Python
Вывод значений параметров на 0ом шаге:\
![Screenshot of the py prog 0](/lab5/img10.png)\
Изменение значений параметров на данном шаге:
![Screenshot of the py prog 1](/lab5/img11.png)\
Демонстрация значений параметров на следующем шаге:\
![Screenshot of the py prog 2](/lab5/img12.png)\
